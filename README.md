# protoc-gen-marshal-zap 
![test](https://github.com/kei2100/protoc-gen-marshal-zap/workflows/test/badge.svg)
![CodeQL](https://github.com/kei2100/protoc-gen-marshal-zap/workflows/CodeQL/badge.svg)

protoc-gen-marshal-zap is a protoc plugin to generate code that implements zapcore.ObjectMarshaler interface ([uber-go/zap](https://github.com/uber-go/zap)) to the protoc message.

## Requirements

- Go compiler and tools
- protoc compiler
- protoc-gen-go

See https://github.com/golang/protobuf#installation

## Installation

```
go install github.com/kei2100/protoc-gen-marshal-zap/plugin/protoc-gen-marshal-zap@latest
```

## Usage
Define your proto file

```proto
syntax = "proto3";

package simple;

// If you want to use "marshal_zap.mask" option, import "marshal-zap.proto"
import "marshal-zap.proto";

message SimpleMessage {
  string message = 1;
  string secret_message = 2 [(marshal_zap.mask) = true];
}
```

Generate the code
```
protoc -I. -I$(go env GOPATH)/src/github.com/kei2100/protoc-gen-marshal-zap --go_out=. --marshal-zap_out=. simple.proto
```

Output results should be:
```
simple.pb.go              # auto-generated by protoc-gen-go
simple.pb.marshal-zap.go  # auto-generated by protoc-gen-marshal-zap
simple.proto              # original proto file
```

`simple.pb.marshal-zap.go` is generated as follows

```go
// Code generated by protoc-gen-marshal-zap. DO NOT EDIT.
// source: simple.pb.go

package simple

import (
        "go.uber.org/zap/zapcore"
        "strconv"
)

// Reference imports to suppress errors if they are not otherwise used.
var _ = zapcore.NewNopCore
var _ = strconv.FormatInt

func (x *SimpleMessage) MarshalLogObject(enc zapcore.ObjectEncoder) error {
        if x == nil {
                return nil
        }

        enc.AddString("message", x.Message)

        enc.AddString("secret_message", "[MASKED]")

        return nil
}
```

## Development
Compile marshal-zap.proto
```
$ make proto
```

Run tests
```
$ make test
```
